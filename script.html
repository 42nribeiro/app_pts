<script>
const OBJETIVOS = ['STRENGTH', 'MOBILITY', 'BALANCE', 'ENDURANCE', 'COORDINATION', 'POWER', 'AGILITY', 'PROPRIOCEPTION', 'POSTURE'];
let contadorPlano = 0;
let planos = [];
let exercicioCounter = 0;
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
let isFiltering = false;
let currentExerciseInputTarget = null;
let fullModalExerciseList = [];
let MASTER_EXERCISE_DATA = {};
let clipboardPlanoData = null;

const avaliacaoModal = document.getElementById('avaliacao-modal');
const avaliacaoModalOverlay = document.getElementById('avaliacao-modal-overlay');
const avaliacaoForm = document.getElementById('avaliacao-form');
const estatisticasModal = document.getElementById('estatisticas-modal');
const estatisticasModalOverlay = document.getElementById('estatisticas-modal-overlay');
let activeCharts = {}; // Armazena instâncias ativas dos gráficos

let allFetchedEvalSeriesData = null;
let allFetchedExerciseProgressData = null;
const evalMainChartContainer = document.getElementById('eval-main-chart-container');
const evalAllChartsContainer = document.getElementById('eval-all-charts-container');
const selectEvalMetric = document.getElementById('select-eval-metric');
const exerciseMainProgressChartContainer = document.getElementById('exercise-main-progress-chart-container');
const selectMuscleGroupProgress = document.getElementById('select-muscle-group-progress');

const nomeFiltroInput = document.getElementById('nomeFiltro');
const clienteSuggestionsDropdown = document.getElementById('clienteSuggestionsDropdown');
let clienteSuggestionTimeout;

// Configuração padrão do Chart.js
if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
    Chart.register(ChartDataLabels);
    Chart.defaults.set('plugins.datalabels', {
        borderRadius: 4,
        font: { weight: 'bold', size: '10' }
    });
    Chart.defaults.font.family = 'Roboto, "Helvetica Neue", Arial, sans-serif';
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#333';
}

function showLoadingIndicator(show) {
    let indicator = document.getElementById('loading-indicator');
    if (indicator) indicator.style.display = show ? 'flex' : 'none';
}

function getCalendarColorStyle(colorId) {
    const colors = { '1': '#a4bdfc', '2': '#7ae7bf', '3': '#dbadff', '4': '#ff887c', '5': '#fbd75b', '6': '#ffb878', '7': '#46d6db', '8': '#e1e1e1', '9': '#5484ed', '10': '#51b749', '11': '#dc2127' };
    return colors[colorId] ? hexToRgba(colors[colorId], 0.12) : null;
}

function hexToRgba(hex, alpha) {
    if (!hex || !hex.startsWith('#')) return null;
    let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}

const alertOverlay = document.getElementById('custom-alert-overlay');
const alertDiv = document.getElementById('custom-alert');
const alertMessage = document.getElementById('custom-alert-message');

function setupAlerts() {
    if (alertOverlay) alertOverlay.addEventListener('click', hideCustomAlert);
    const closeButton = alertDiv?.querySelector('button');
    if (closeButton) closeButton.addEventListener('click', hideCustomAlert);
    else if (alertDiv) alertDiv.addEventListener('click', hideCustomAlert);
}

function showCustomAlert(message, isError = false, duration = 3000) {
    if (!alertDiv || !alertMessage || !alertOverlay) { alert(message); return; }
    alertMessage.innerHTML = message;
    alertDiv.className = 'custom-alert'; // Reset classes
    alertDiv.classList.add(isError ? 'error' : 'success');
    alertOverlay.style.display = 'block';
    alertDiv.style.display = 'block';
    void alertDiv.offsetWidth; // Trigger reflow
    alertDiv.style.opacity = 1;
    alertDiv.style.transform = 'translate(-50%, -50%) scale(1)';
    setTimeout(hideCustomAlert, duration);
}

function hideCustomAlert() {
    if (alertDiv) {
        alertDiv.style.opacity = 0;
        alertDiv.style.transform = 'translate(-50%, -50%) scale(0.95)';
        setTimeout(() => {
            if (alertDiv) alertDiv.style.display = 'none';
            if (alertOverlay) alertOverlay.style.display = 'none';
        }, 200);
    } else if (alertOverlay) {
        alertOverlay.style.display = 'none';
    }
}

function handleBackendError(error) {
    showLoadingIndicator(false);
    console.error('Erro backend:', error);
    let message = "Erro inesperado.";
    if (error?.message) message = `Erro: ${error.message}`;
    else if (typeof error === 'string') message = error;
    if (error?.mensagem) message = error.mensagem; // Priorizar mensagem do backend
    showCustomAlert(message, true);
    const plansContainer = document.getElementById('training-plans');
    if (plansContainer) plansContainer.innerHTML = '<p class="text-center text-muted p-3">Erro ao carregar.</p>';
    resetHeaderStats();
    enableActionButtons();
    isFiltering = false;
}

function resetHeaderStats() {
    const setVal = (id, value) => { const el = document.getElementById(id); if (el) el.value = value; };
    setVal('treinosConcluidos', '0');
    setVal('numeroTreinos', '0');
    setVal('filtroHoras', '--');
    setVal('filtroNivel', '--');
}

function disableActionButtons() {
    const filterBtn = document.querySelector('#filter-button-container button.btn-primary');
    const metricsBtn = document.getElementById('calcularMetricasBtn');
    const statsBtn = document.getElementById('estatisticasBtn');
    if (filterBtn) filterBtn.disabled = true;
    if (metricsBtn) metricsBtn.disabled = true;
    if (statsBtn) statsBtn.disabled = true;
}

function enableActionButtons() {
    const filterBtn = document.querySelector('#filter-button-container button.btn-primary');
    const metricsBtn = document.getElementById('calcularMetricasBtn');
    const statsBtn = document.getElementById('estatisticasBtn');
    if (filterBtn) filterBtn.disabled = false;
    if (metricsBtn) metricsBtn.disabled = false;
    if (statsBtn) statsBtn.disabled = false;
}

function filtrarPlanos() {
    if (isFiltering) return;
    isFiltering = true;
    disableActionButtons();
    showLoadingIndicator(true);
    const getInputValue = id => document.getElementById(id)?.value?.trim() ?? '';
    const getSelectValue = id => document.getElementById(id)?.value ?? '';
    let nomeFiltro = getInputValue('nomeFiltro').toLowerCase();
    if (nomeFiltro === '') nomeFiltro = 'pro'; // Padrão se vazio
    const personalTrainer = getSelectValue('personalTrainer');
    const cor = getSelectValue('cor');
    let dataInicioStr = '', dataFimStr = '';
    const datePicker = document.querySelector("#dateRangeFilter")?._flatpickr;
    if (datePicker && datePicker.selectedDates.length > 0) {
        dataInicioStr = flatpickr.formatDate(datePicker.selectedDates[0], "d/m/Y");
        dataFimStr = datePicker.selectedDates.length > 1 ? flatpickr.formatDate(datePicker.selectedDates[1], "d/m/Y") : dataInicioStr;
    }
    google.script.run
        .withSuccessHandler(r => { mostrarPlanos(r); enableActionButtons(); isFiltering = false; })
        .withFailureHandler(e => { handleBackendError(e); isFiltering = false; })
        .getPlanos(nomeFiltro, dataInicioStr, dataFimStr, personalTrainer, cor);
}

function executarCalculoMetricas() {
    disableActionButtons();
    showLoadingIndicator(true);
    const getInputValue = id => document.getElementById(id)?.value?.trim() ?? '';
    const getSelectValue = id => document.getElementById(id)?.value ?? '';
    let nomeFiltro = getInputValue('nomeFiltro').toLowerCase();
    if (nomeFiltro === '') nomeFiltro = 'pro'; // Padrão se vazio
    const personalTrainer = getSelectValue('personalTrainer');
    const cor = getSelectValue('cor');
    let dataInicioStr = '', dataFimStr = '', periodoSelecionadoStr = "Período Não Especificado";
    const datePicker = document.querySelector("#dateRangeFilter")?._flatpickr;
    const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

    if (datePicker && datePicker.selectedDates.length > 0) {
        const dataInicioObj = datePicker.selectedDates[0];
        dataInicioStr = flatpickr.formatDate(dataInicioObj, "d/m/Y");
        if (datePicker.selectedDates.length > 1) {
            const dataFimObj = datePicker.selectedDates[1];
            dataFimStr = flatpickr.formatDate(dataFimObj, "d/m/Y");
            const mesInicioNome = meses[dataInicioObj.getMonth()], anoInicio = dataInicioObj.getFullYear();
            const mesFimNome = meses[dataFimObj.getMonth()], anoFim = dataFimObj.getFullYear();
            periodoSelecionadoStr = mesInicioNome === mesFimNome && anoInicio === anoFim ? `${mesInicioNome} de ${anoInicio}` :
                                 anoInicio === anoFim ? `${mesInicioNome} a ${mesFimNome} de ${anoInicio}` :
                                 `${mesInicioNome}/${anoInicio} a ${mesFimNome}/${anoFim}`;
        } else {
            dataFimStr = dataInicioStr;
            periodoSelecionadoStr = `${meses[dataInicioObj.getMonth()]} de ${dataInicioObj.getFullYear()}`;
        }
    } else { // Padrão: Mês atual
        const hoje = new Date();
        periodoSelecionadoStr = `Mês Atual (${meses[hoje.getMonth()]} de ${hoje.getFullYear()})`;
    }
    const plansContainer = document.getElementById('training-plans');
    if (plansContainer) plansContainer.innerHTML = ''; // Limpar área de planos
    google.script.run
        .withSuccessHandler(r => { atualizarDisplayMetricas(r, periodoSelecionadoStr); enableActionButtons(); })
        .withFailureHandler(handleBackendError)
        .calcularMetricas(nomeFiltro, dataInicioStr, dataFimStr, personalTrainer, cor);
}

function atualizarDisplayMetricas(r, periodoParaTitulo = "Eventos Únicos") {
    showLoadingIndicator(false);
    const container = document.getElementById('training-plans');
    if (!r || r.erro) { handleBackendError(r); return; }
    const updateInput = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
    updateInput('numeroTreinos', r.totalEventos ?? 0);
    updateInput('filtroHoras', typeof r.totalHoras === 'number' ? r.totalHoras.toFixed(2) : '--');
    updateInput('filtroNivel', typeof r.nivel === 'number' ? r.nivel.toFixed(2) : '--');
    updateInput('treinosConcluidos', r.eventosConcluidos ?? 0);

    if (!container) { console.error("Container 'training-plans' não encontrado."); return; }
    container.innerHTML = ''; // Limpa conteúdo anterior

    // Tabela de Detalhes do Nível
    if (r.detalhesNivel && r.detalhesNivel.length > 0) {
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'container-fluid mt-3'; tableWrapper.id = 'detailed-metrics-table-container';
        const title = document.createElement('h5'); title.textContent = `Detalhes do Cálculo de Nível (${periodoParaTitulo})`;
        tableWrapper.appendChild(title);
        const responsiveDiv = document.createElement('div'); responsiveDiv.className = 'table-responsive';
        const table = document.createElement('table'); table.className = 'table table-sm table-bordered table-striped';
        const thead = table.createTHead(), headerRow = thead.insertRow();
        ['Evento', 'Valor', 'Tipo'].forEach(text => {
            const th = document.createElement('th'); th.textContent = text;
            if (text === 'Valor') th.style.textAlign = 'right';
            headerRow.appendChild(th);
        });
        const tbody = table.createTBody();
        r.detalhesNivel.forEach(d => {
            const row = tbody.insertRow(), cellTitulo = row.insertCell(), cellValor = row.insertCell(), cellTipo = row.insertCell();
            cellTitulo.textContent = d.titulo;
            cellValor.textContent = d.valor.toFixed(2); cellValor.style.textAlign = 'right';
            cellTipo.textContent = d.tipoPagamento || 'N/A';
        });
        responsiveDiv.appendChild(table); tableWrapper.appendChild(responsiveDiv); container.appendChild(tableWrapper);
    } else {
        // Apenas mostrar mensagem se AMBAS as tabelas estiverem vazias
        if (!r.dadosClientePorRef || Object.keys(r.dadosClientePorRef).length === 0) {
            const noMsg = document.createElement('p'); noMsg.className = 'text-center text-muted p-3';
            noMsg.textContent = "Nenhum evento contribuiu para o cálculo de nível ou não há dados de cliente para exibir com os filtros atuais.";
            container.appendChild(noMsg);
        }
    }

    // Tabela de Treinos por Cliente e M.Ref
    if (r.dadosClientePorRef && Object.keys(r.dadosClientePorRef).length > 0) {
        const clientDataContainer = document.createElement('div'); clientDataContainer.className = 'container-fluid mt-4'; clientDataContainer.id = 'client-mref-metrics-table-container';
        const clientTitle = document.createElement('h5'); clientTitle.textContent = `Treinos por Cliente e M.Ref (${periodoParaTitulo})`;
        clientDataContainer.appendChild(clientTitle);
        const clientResponsiveDiv = document.createElement('div'); clientResponsiveDiv.className = 'table-responsive';
        const clientTable = document.createElement('table'); clientTable.className = 'table table-sm table-bordered table-striped';
        const clientThead = clientTable.createTHead(), clientHeaderRow = clientThead.insertRow();
        const thCli = document.createElement('th'); thCli.textContent = 'Cliente'; clientHeaderRow.appendChild(thCli);
        const thMRef = document.createElement('th'); thMRef.textContent = 'M.Ref'; clientHeaderRow.appendChild(thMRef);
        const thQtd = document.createElement('th'); thQtd.textContent = 'Nº Treinos'; thQtd.style.textAlign = 'right'; clientHeaderRow.appendChild(thQtd);
        const clientTbody = clientTable.createTBody();

        const entradasCliente = Object.values(r.dadosClientePorRef).sort((a, b) => {
            const compNome = a.nomeCliente.localeCompare(b.nomeCliente);
            if (compNome !== 0) return compNome;
            // Ordenar "N/A" (ou "--") por último
            return (a.mRef === "N/A" ? String.fromCharCode(255) : a.mRef).localeCompare(b.mRef === "N/A" ? String.fromCharCode(255) : b.mRef);
        });

        for (const info of entradasCliente) {
            const row = clientTbody.insertRow(), cellNome = row.insertCell(), cellMRef = row.insertCell(), cellCount = row.insertCell();
            cellNome.textContent = info.nomeCliente;
            cellMRef.textContent = info.mRef === "N/A" ? '--' : info.mRef; // Exibir "--" para N/A
            cellCount.textContent = info.count; cellCount.style.textAlign = 'right';
        }
        clientResponsiveDiv.appendChild(clientTable); clientDataContainer.appendChild(clientResponsiveDiv); container.appendChild(clientDataContainer);
    }
}


function salvarPlano(idHTML) {
    const pIndex = planos.findIndex(pl => pl.contadorPlano === idHTML);
    if (pIndex === -1) { showCustomAlert(`Erro: Plano ${idHTML} não encontrado.`, true); return; }
    const p = planos[pIndex];
    const cH = document.getElementById(`card-header-${idHTML}`);
    if (cH) {
        const sI = cH.querySelector('.sessao-inicio'), sF = cH.querySelector('.sessao-fim'), st = cH.querySelector('.status-select'), mRefInput = cH.querySelector('.m-ref-input');
        if (sI) p.sessao = sI.value; // sessao e mes são clienteContagem e clienteMes no backend
        if (sF) p.mes = sF.value;
        if (st) p.status = st.value;
        if (mRefInput) p.mRef = mRefInput.value;
    }
    const tD = getExercisesData(idHTML);
    p.exercicios = tD.exercises || [];
    disableActionButtons(); showLoadingIndicator(true);
    const dS = { planUuid: p.planUuid, eventId: p.eventId, cliente: p.cliente, data: p.data, hora: p.hora, duracao: p.duracao, sessao: p.sessao, mes: p.mes, exercicios: p.exercicios, cor: p.cor, mRef: p.mRef, avaliacao: p.avaliacao || null };
    google.script.run
        .withSuccessHandler(r => {
            showLoadingIndicator(false); enableActionButtons();
            if (!r || r.erro) { showCustomAlert(r?.mensagem || r?.erro || "Falha ao salvar.", true); return; }
            showCustomAlert(r.mensagem?.includes("arquivado") ? "Arquivado!" : "Salvo!", false);
            const idx = planos.findIndex(pl => pl.contadorPlano === idHTML);
            if (idx !== -1) { // Atualizar dados locais do plano com o retorno do servidor
                planos[idx] = { ...planos[idx], sessao: r.sessao ?? planos[idx].sessao, mes: r.mes ?? planos[idx].mes, status: r.status ?? planos[idx].status, exercicios: r.exercicios ?? planos[idx].exercicios, mRef: r.mRef ?? planos[idx].mRef, avaliacao: r.avaliacao ?? planos[idx].avaliacao };
                // Atualizar UI com os dados retornados
                const cardStatusSelect = document.querySelector(`#card-header-${idHTML} .status-select`); if (cardStatusSelect) cardStatusSelect.value = planos[idx].status;
                const sessaoInicioInput = document.querySelector(`#card-header-${idHTML} .sessao-inicio`); if (sessaoInicioInput) sessaoInicioInput.value = planos[idx].sessao ?? '';
                const mesFimInput = document.querySelector(`#card-header-${idHTML} .sessao-fim`); if (mesFimInput) mesFimInput.value = planos[idx].mes ?? '';
                const mRefEl = document.querySelector(`#card-header-${idHTML} .m-ref-input`); if (mRefEl) mRefEl.value = planos[idx].mRef ?? '';
            }
            const finalStatus = r.status || p.status;
            setReadOnlyState(idHTML, finalStatus === 'Done');
        })
        .withFailureHandler(handleBackendError)
        .savePlano(dS, p.status); // Envia o status atual para lógica de arquivamento
}


function mostrarPlanos(r) {
    showLoadingIndicator(false);
    const c = document.getElementById('training-plans');
    if (!c) return;
    c.innerHTML = ''; // Limpa container de planos
    if (!r || r.erro) { handleBackendError(r); return; }
    MASTER_EXERCISE_DATA = r.masterExercises || {};
    planos = r.planos || [];
    const pA = new Set(); // Planos abertos
    document.querySelectorAll('.plano-conteudo[style*="display: block"]').forEach(e => { const ca = e.closest('.card'); if (ca?.dataset.planUuid) pA.add(ca.dataset.planUuid); });
    contadorPlano = 0;
    let tD = 0; // Treinos concluídos
    const f = document.createDocumentFragment(); // Usar fragmento para performance
    const uI_local = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };

    if (planos.length === 0) { c.innerHTML = '<p class="text-center text-muted p-3">Nenhum plano encontrado.</p>'; resetHeaderStats(); }
    else {
        planos.forEach((pD, idx) => {
            if (!pD?.planUuid) return; // Pular planos inválidos
            pD.contadorPlano = idx + 1; contadorPlano = pD.contadorPlano; // Atualizar contador global
            const pE = criarElementoPlano(pD, pD.contadorPlano, MASTER_EXERCISE_DATA);
            f.appendChild(pE);
            if (pD.status === 'Done') tD++;
        });
        c.appendChild(f); // Adicionar todos os planos de uma vez
        // Restaurar estado de Sortable e planos abertos
        planos.forEach(p => {
            const sL = document.getElementById(`exercise-list-${p.contadorPlano}`);
            if (typeof Sortable !== 'undefined' && sL && !sL.sortableInstance) { // Inicializar Sortable se não existir
                try { sL.sortableInstance = new Sortable(sL, { animation: 150, handle: '.handle', draggable: '.sortable-item', group: `plano-${p.contadorPlano}`, disabled: p.status === 'Done' }); if (p.status === 'Done') sL.style.cursor = 'default'; } catch (e) { console.error("Error Sortable:", p.contadorPlano, e); }
            } else if (sL && sL.sortableInstance) { // Atualizar estado do Sortable existente
                sL.sortableInstance.option('disabled', p.status === 'Done'); sL.style.cursor = p.status === 'Done' ? 'default' : 'auto';
            }
            if (pA.has(p.planUuid)) { // Reabrir planos que estavam abertos
                const ca = document.querySelector(`.card[data-plan-uuid="${p.planUuid}"]`), co = ca?.querySelector('.plano-conteudo');
                if (co && (co.style.display === 'none' || co.style.display === '')) togglePlano(p.contadorPlano);
            }
        });
        uI_local('treinosConcluidos', tD); uI_local('numeroTreinos', planos.length);
        if (planos.length > 0) { uI_local('filtroHoras', '--'); uI_local('filtroNivel', '--'); } // Resetar se houver planos
    }
}

function criarElementoPlano(pD, idHTML, mE) {
    const c = document.createElement('div');
    c.className = 'card mb-3';
    c.dataset.planUuid = String(pD.planUuid ?? '');
    const eventIdStr = String(pD.eventId ?? '');
    const { clienteContagem: sV, clienteMes: mV, data, hora, duracao, cliente, status, planUuid, exercicios: ex = [], cor, mRef } = pD;
    const iD = status === 'Done'; // isDone
    const uC = String(cliente ?? '').toUpperCase(); // upperCaseCliente
    if (uC.includes('PRO DUO')) c.classList.add('pro-duo-card');
    else if (uC.includes('PRO')) c.classList.add('pro-card');
    else if (uC.includes('FISIO')) c.classList.add('fisio-card');
    else if (uC.includes('NUTRI')) c.classList.add('nutri-card');
    const bC = getCalendarColorStyle(cor); // backgroundColor
    if (bC) c.style.backgroundColor = bC;

    // Usar template literals para clareza, mas ciente do impacto em performance extrema (aqui é aceitável)
    c.innerHTML = `<div class="card-header" id="card-header-${idHTML}" onclick="togglePlano(${idHTML})"><div title="Sessão"><span class="small text-muted">S:</span><input type="number" class="form-control form-control-sm sessao-inicio" value="${sV ?? ''}" ${iD ? 'readonly' : ''}> <span class="text-muted">/</span> <input type="number" class="form-control form-control-sm sessao-fim" value="${mV ?? ''}" ${iD ? 'readonly' : ''}></div><div title="Data"><span class="small text-muted">D:</span><input type="text" class="form-control form-control-sm" value="${data || ''}" readonly></div><div title="Hora"><span class="small text-muted">H:</span><input type="text" class="form-control form-control-sm" value="${hora || ''}" readonly></div><div title="Duração"><span class="small text-muted">T:</span><input type="text" class="form-control form-control-sm" value="${duracao || ''}" readonly></div><div title="Cliente"><span class="small text-muted">Cli:</span><input type="text" class="form-control form-control-sm cliente-nome-display" value="${cliente || 'N/A'}" readonly></div><div title="M.Ref"><span class="small text-muted">M.Ref:</span><input type="text" class="form-control form-control-sm m-ref-input" value="${mRef ?? ''}" placeholder="..." ${iD ? 'readonly' : ''}></div><div title="Status"><select class="status-select form-control form-control-sm" data-plano-id="${idHTML}" ${iD ? 'disabled' : ''}><option value="Edit" ${status === 'Edit' ? 'selected' : ''}>Edit</option><option value="Done" ${status === 'Done' ? 'selected' : ''}>Done</option></select></div></div><div class="card-body plano-conteudo" id="plano-conteudo-${idHTML}" style="display:none;"><div class="exercise-list mb-3" id="exercise-list-${idHTML}"></div><div class="d-flex justify-content-between flex-wrap mt-2" style="gap:10px;"><div class="d-flex flex-wrap" style="gap:5px;"><button class="btn btn-primary btn-sm" onclick="adicionarExercicio(${idHTML})" ${iD ? 'disabled' : ''} title="Adicionar Exercício"><i class="fas fa-plus"></i> Exer.</button><button class="btn btn-secondary btn-sm" onclick="adicionarObservacao(${idHTML})" ${iD ? 'disabled' : ''} title="Adicionar Observação"><i class="fas fa-comment-alt"></i> Obs.</button><button class="btn btn-success btn-sm avaliacao-btn" onclick="abrirModalAvaliacao(${idHTML})" ${iD ? 'disabled' : ''} title="Registar Avaliação"><i class="fas fa-clipboard-list"></i> Eva.</button><button class="btn btn-info btn-sm" onclick="copiarPlano(${idHTML})" title="Copiar Conteúdo"><i class="fas fa-copy"></i> Copiar</button><button class="btn btn-warning btn-sm" onclick="colarPlano(${idHTML})" ${iD ? 'disabled' : ''} title="Colar Conteúdo"><i class="fas fa-paste"></i> Colar</button></div><button class="btn btn-success btn-sm salvar-btn ml-auto" onclick="salvarPlano(${idHTML})" data-plano-uuid="${String(planUuid ?? '')}" data-event-id="${eventIdStr}" ${iD ? 'disabled' : ''} title="Salvar"><i class="fas fa-save"></i> Salvar</button></div></div>`;
    const lC = c.querySelector(`#exercise-list-${idHTML}`); // listContainer
    if (lC) { lC.addEventListener('input', handleExerciseListInput); lC.addEventListener('change', handleExerciseListInput); }
    const sS = c.querySelector('.status-select'), sI = c.querySelector('.sessao-inicio'), sF = c.querySelector('.sessao-fim'), mRI = c.querySelector('.m-ref-input');
    if (mRI && sS) { mRI.addEventListener('change', e => { const pIdStr = sS.dataset.planoId; if (pIdStr) { const pId = parseInt(pIdStr, 10), pU = planos.find(pl => pl.contadorPlano === pId); if (pU) pU.mRef = e.target.value; } }); }
    if (sS) sS.addEventListener('change', handleStatusChange);
    if (sI) sI.addEventListener('change', handleSessaoChange);
    if (sF) sF.addEventListener('change', handleSessaoChange);
    if (lC && ex?.length > 0) ex.forEach(item => adicionarExercicioComDados(idHTML, item, lC, iD, mE));
    setReadOnlyState(idHTML, iD); return c;
}

function handleStatusChange(e) { const s = e.target, id = parseInt(s.dataset.planoId, 10), p = planos.find(pL => pL.contadorPlano === id); if (p) p.status = s.value; }
function handleSessaoChange(e) { const i = e.target, cH = i.closest('.card-header'); if (!cH) return; const sS = cH.querySelector('.status-select'); if (!sS) return; const id = parseInt(sS.dataset.planoId, 10), p = planos.find(pL => pL.contadorPlano === id); if (p) { if (i.classList.contains('sessao-inicio')) p.sessao = i.value; else if (i.classList.contains('sessao-fim')) p.mes = i.value; } }
function togglePlano(id) { const c = document.getElementById(`plano-conteudo-${id}`), h = document.getElementById(`card-header-${id}`); if (!c || !h) return; const ca = h.closest('.card'), o = c.style.display === 'block'; c.style.display = o ? 'none' : 'block'; ca?.classList.toggle('card-open', !o); }

function toggleFilterVisibility() {
    const f = document.getElementById('filter-container');
    const t = document.getElementById('toggleFilter');
    if (!f || !t) return;
    hideClienteSuggestions(); // Esconder sugestões ao abrir/fechar filtros
    const isCollapsed = f.classList.contains('collapsed');
    if (isCollapsed) { // Abrir
        f.style.overflow = 'hidden'; // Prevenir overflow durante a transição
        f.classList.remove('collapsed');
        f.style.maxHeight = f.scrollHeight + 'px'; // Animar para a altura do conteúdo
        t.innerHTML = '<i class="fas fa-times"></i>'; // Ícone de fechar
        setTimeout(() => { // Após a transição, permitir overflow se necessário
            if (!f.classList.contains('collapsed')) { // Verificar se não foi fechado novamente
                f.style.maxHeight = 'none';
                f.style.overflow = 'visible';
            }
        }, 300); // Duração da transição CSS
    } else { // Fechar
        f.style.overflow = 'hidden';
        f.style.maxHeight = f.scrollHeight + 'px'; // Definir altura explícita para animar
        void f.offsetWidth; // Forçar reflow
        f.style.maxHeight = '0px'; // Animar para altura 0
        f.classList.add('collapsed');
        t.innerHTML = '<i class="fas fa-filter"></i>'; // Ícone de filtro
    }
}


function adicionarExercicio(id) { const lC = document.getElementById(`exercise-list-${id}`); if (!lC) return; const sS = document.getElementById(`card-header-${id}`)?.querySelector('.status-select'); if (sS?.value === 'Done') return; exercicioCounter++; const eD = document.createElement('div'); eD.className = 'exercise-container sortable-item border rounded mb-2 shadow-sm'; eD.dataset.highlightState = 'neutral'; if (lC.children.length % 2 === 0) eD.classList.add('exercise-alternate'); const eG = Object.keys(MASTER_EXERCISE_DATA || {}); eD.innerHTML = `<div class="handle-container" style="grid-area:handle;"><i class="fas fa-grip-vertical handle text-muted" onclick="cycleHighlight(this)"></i></div><div class="exercise-content-wrapper"><div class="exercise-header"><select class="form-control form-control-sm objetivo objetivo-${id}" title="Objetivo"><option value="" disabled selected>-- Objetivo --</option>${OBJETIVOS.map(o => `<option value="${o}">${o}</option>`).join('')}</select><select class="form-control form-control-sm grupoMuscular grupoMuscular-${id}" onchange="atualizarExercicios(this)" title="Grupo Muscular"><option value="" disabled selected>-- Grupo Muscular --</option>${eG.map(g => `<option value="${g}">${g}</option>`).join('')}</select></div><div class="exercise-main-content"><input type="text" class="form-control form-control-sm exercicio exercicio-${id}" placeholder="Exercício" title="Nome" autocomplete="off"><button type="button" class="btn btn-sm select-exercise-button" onclick="handleExerciseFocus(this)" title="Selecionar Exercício"><i class="fas fa-list"></i></button></div><div class="exercise-footer-content"><div class="series-controls"><button type="button" class="btn btn-sm btn-outline-secondary series-btn" onclick="alterarSeries(this,${id},-1)" title="Menos Séries"><i class="fas fa-minus"></i></button><input type="number" class="form-control form-control-sm series-value" value="3" min="1" max="10" readonly title="Séries"><button type="button" class="btn btn-sm btn-outline-secondary series-btn" onclick="alterarSeries(this,${id},1)" title="Mais Séries"><i class="fas fa-plus"></i></button></div><div class="series-detail-container"></div></div></div><div style="grid-area:delete;" class="delete-button-container"><button class="btn btn-light btn-sm" onclick="this.closest('.sortable-item').remove()" title="Remover"><i class="fas fa-trash text-danger"></i></button></div>`; lC.appendChild(eD); const sI = eD.querySelector('.series-value'); if (sI) atualizarRepeticoes(sI, id); }
function adicionarObservacao(id) { const lC = document.getElementById(`exercise-list-${id}`); if (!lC) return; const sS = document.getElementById(`card-header-${id}`)?.querySelector('.status-select'); if (sS?.value === 'Done') return; exercicioCounter++; const oD = document.createElement('div'); oD.className = 'observation-container sortable-item border rounded mb-2 bg-light'; oD.dataset.highlightState = 'neutral'; if (lC.children.length % 2 === 0) oD.classList.add('exercise-alternate'); oD.innerHTML = `<div class="handle-container" style="grid-area:handle;"><i class="fas fa-grip-vertical handle text-muted" onclick="cycleHighlight(this)"></i></div><div class="observation-content-wrapper" style="grid-area:input;"><input type="text" class="form-control form-control-sm observacao-texto observacao-texto-${id}" placeholder="Observação..." title="Observação"></div><div style="grid-area:delete;" class="delete-button-container"><button class="btn btn-light btn-sm" onclick="this.closest('.sortable-item').remove()" title="Remover"><i class="fas fa-trash text-danger"></i></button></div>`; lC.appendChild(oD); }
function atualizarExercicios(sE) { const sG = sE.value, eC = sE.closest('.exercise-container'); if (!eC || typeof MASTER_EXERCISE_DATA === 'undefined') return; const eI = eC.querySelector('.exercicio'); if (eI) { eI.value = ''; const eL = MASTER_EXERCISE_DATA[sG] || []; eI.dataset.exerciseList = JSON.stringify(eL); if (currentExerciseInputTarget === eI) { fullModalExerciseList = eL; populateModalList(fullModalExerciseList, modalSearchInput.value); } } }
function alterarSeries(b, id, inc) { const eC = b.closest('.exercise-container'); if (!eC) return; const sS = document.getElementById(`card-header-${id}`)?.querySelector('.status-select'); if (sS?.value === 'Done' || eC.classList.contains('item-readonly')) return; const sI = eC.querySelector('.series-value'); if (!sI) return; let cS = parseInt(sI.value, 10); if (isNaN(cS)) cS = 1; let nS = cS + inc; nS = Math.max(1, Math.min(10, nS)); sI.value = nS; atualizarRepeticoes(sI, id); }
function atualizarRepeticoes(sI, id) { const eC = sI.closest('.exercise-container'); if (!eC) return; const sDC = eC.querySelector('.series-detail-container'); if (!sDC) return; const tC = parseInt(sI.value, 10); if (isNaN(tC) || tC < 1) { sDC.innerHTML = ''; return; } const sS = document.getElementById(`card-header-${id}`)?.querySelector('.status-select'), iRO = sS?.value === 'Done' || eC.classList.contains('item-readonly'), eCs = sDC.querySelectorAll('.series-column'), cC = eCs.length; if (tC > cC) { for (let i = cC; i < tC; i++) { const sC = document.createElement('div'); sC.className = 'series-column'; const rTG = document.createElement('div'); rTG.className = 'input-group input-group-sm series-rep-tempo-group'; rTG.innerHTML = `<input type="number" class="form-control manual-rep-tempo" placeholder="-" value="" ${iRO ? 'readonly' : ''} title="Rep/Tempo ${i + 1}" min="0"><select class="form-control unit-select rep-tempo-unit" ${iRO ? 'disabled' : ''} title="Unidade Rep/Tempo ${i + 1}"><option value="rep">rep</option><option value="sec">sec</option><option value="min">min</option></select>`; sC.appendChild(rTG); const wG = document.createElement('div'); wG.className = 'input-group input-group-sm series-weight-group'; wG.innerHTML = `<input type="number" step="any" class="form-control peso-value" placeholder="-" value="" ${iRO ? 'readonly' : ''} title="Peso ${i + 1}" min="0"><select class="form-control unit-select peso-unit" ${iRO ? 'disabled' : ''} title="Unidade Peso ${i + 1}"><option value="kg">kg</option><option value="lbs" selected>lbs</option><option value="body" ${iRO ? 'disabled' : ''}>body</option></select>`; sC.appendChild(wG); sDC.appendChild(sC); } } else if (tC < cC) { for (let i = cC - 1; i >= tC; i--) if (eCs[i]) eCs[i].remove(); } }
function handleExerciseListInput(e) { const t = e.target, isRepT = t.classList.contains('manual-rep-tempo'), isP = t.classList.contains('peso-value'), isRepTU = t.classList.contains('rep-tempo-unit'), isPU = t.classList.contains('peso-unit'); if (!isRepT && !isP && !isRepTU && !isPU) return; const sC = t.closest('.series-column'); if (!sC) return; const sDC = sC.closest('.series-detail-container'); if (!sDC || sC !== sDC.querySelector('.series-column:first-child')) return; const eC = t.closest('.exercise-container'); if (eC?.classList.contains('item-readonly')) return; const v = t.value; let sel = ''; if (isRepT) sel = '.manual-rep-tempo'; else if (isP) sel = '.peso-value'; else if (isRepTU) sel = '.rep-tempo-unit'; else if (isPU) sel = '.peso-unit'; if (sel) sDC.querySelectorAll(`.series-column ${sel}`).forEach((oi, idx) => { if (idx > 0) oi.value = v; }); }

const exerciseModal = document.getElementById('exercise-modal'), modalListContainer = document.getElementById('modal-exercise-list'), modalSearchInput = document.getElementById('modal-search-input');
function handleExerciseFocus(b) { const i = b.previousElementSibling; if (i.closest('.plan-readonly') || i.closest('.item-readonly')) return; showExerciseModal(i); }
function showExerciseModal(tIE) { if (typeof MASTER_EXERCISE_DATA === 'undefined') { showCustomAlert("Lista de exercícios não carregada.", true); return; } currentExerciseInputTarget = tIE; fullModalExerciseList = []; const eC = tIE.closest('.exercise-container'), gMS = eC?.querySelector('.grupoMuscular'), sMG = gMS?.value; if (!sMG) { showCustomAlert("Selecione um Grupo Muscular.", false); currentExerciseInputTarget = null; return; } fullModalExerciseList = MASTER_EXERCISE_DATA[sMG] || []; tIE.dataset.exerciseList = JSON.stringify(fullModalExerciseList); modalSearchInput.value = ''; populateModalList(fullModalExerciseList, ''); modalSearchInput.oninput = () => { const sT = modalSearchInput.value.toLowerCase(), fL = fullModalExerciseList.filter(ex => ex.toLowerCase().includes(sT)); populateModalList(fL, modalSearchInput.value); }; if (alertOverlay) alertOverlay.style.display = 'block'; if (exerciseModal) { exerciseModal.style.display = 'flex'; setTimeout(() => modalSearchInput.focus(), 50); } }
function hideExerciseModal() { if (alertOverlay) alertOverlay.style.display = 'none'; if (exerciseModal) exerciseModal.style.display = 'none'; if (modalListContainer) modalListContainer.innerHTML = ''; currentExerciseInputTarget = null; fullModalExerciseList = []; if (modalSearchInput) modalSearchInput.oninput = null; }
function populateModalList(l, sT = '') { if (!modalListContainer) return; modalListContainer.innerHTML = ''; const sL = sT.toLowerCase(), tST = sT.trim(); if (l.length === 0 && tST.length > 0) { const aI = document.createElement('div'); aI.className = 'add-new-suggestion'; aI.innerHTML = `<i class="fas fa-plus-circle"></i> Adicionar '<strong>${tST}</strong>'`; aI.onclick = () => { addNewExerciseToList(tST); }; modalListContainer.appendChild(aI); } else if (l.length === 0) modalListContainer.innerHTML = '<div style="padding:10px;text-align:center;color:#6c757d;">Nenhum exercício.</div>'; l.forEach(ex => { const i = document.createElement('div'); i.className = 'suggestion-item'; if (sL.length > 0) { const mI = ex.toLowerCase().indexOf(sL); if (mI > -1) i.innerHTML = ex.substring(0, mI) + '<strong>' + ex.substring(mI, mI + sL.length) + '</strong>' + ex.substring(mI + sL.length); else i.textContent = ex; } else i.textContent = ex; i.onclick = () => { selectExerciseFromModal(ex); }; modalListContainer.appendChild(i); }); }
function selectExerciseFromModal(sET) { if (currentExerciseInputTarget) currentExerciseInputTarget.value = sET.trim(); hideExerciseModal(); }
function addNewExerciseToList(nEN) { if (!currentExerciseInputTarget) return; const tN = nEN.trim(); if (!tN) { showCustomAlert("Nome do exercício vazio.", true); return; } const eC = currentExerciseInputTarget.closest('.exercise-container'), gMS = eC?.querySelector('.grupoMuscular'), sMG = gMS?.value; if (!sMG) { showCustomAlert("Grupo Muscular não selecionado.", true); return; } if (typeof MASTER_EXERCISE_DATA === 'undefined') { showCustomAlert("Lista de exercícios não carregada.", true); return; } const lTN = tN.toLowerCase(); if (MASTER_EXERCISE_DATA[sMG]?.some(ex => ex.toLowerCase() === lTN)) { showCustomAlert(`'${tN}' já existe em ${sMG}.`, false); selectExerciseFromModal(tN); return; } if (!MASTER_EXERCISE_DATA[sMG]) MASTER_EXERCISE_DATA[sMG] = []; MASTER_EXERCISE_DATA[sMG].push(tN); MASTER_EXERCISE_DATA[sMG].sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' })); fullModalExerciseList = MASTER_EXERCISE_DATA[sMG]; const sT = modalSearchInput.value.toLowerCase(), fL = fullModalExerciseList.filter(ex => ex.toLowerCase().includes(sT)); populateModalList(fL, modalSearchInput.value); currentExerciseInputTarget.dataset.exerciseList = JSON.stringify(MASTER_EXERCISE_DATA[sMG]); selectExerciseFromModal(tN); showCustomAlert(`'${tN}' adicionado! Salvando...`, false); google.script.run.withSuccessHandler(r => { if (r && r.success) console.log(`[addExToList] Saved ${tN} for ${sMG}.`); else { console.error(`[addExToList] Fail save ${tN}:`, r?.error); showCustomAlert(`Falha salvar '${tN}': ${r?.error || 'Erro desc.'}`, true); } }).withFailureHandler(e => { console.error(`[addExToList] Fail handler ${tN}:`, e); showCustomAlert(`Erro comunicação ao salvar '${tN}'.`, true); }).saveNewMasterExercise(tN, sMG); }
function adicionarExercicioComDados(id, iD, cE, iPD, mE) { if (!iD || !cE) return; exercicioCounter++; if (iD.type === 'exercise') { const eD = document.createElement('div'); eD.className = 'exercise-container sortable-item border rounded mb-2 shadow-sm'; eD.dataset.highlightState = iD.highlight || 'neutral'; if (eD.dataset.highlightState !== 'neutral') eD.classList.add(`highlight-${eD.dataset.highlightState}`); if (cE.children.length % 2 === 0) eD.classList.add('exercise-alternate'); if (iPD) eD.classList.add('item-readonly'); const eG = Object.keys(mE || {}), cELFG = (mE && iD.grupoMuscular && mE[iD.grupoMuscular]) ? mE[iD.grupoMuscular] : [], nE = iD.exerciseName || iD.exercicio || ''; eD.innerHTML = `<div class="handle-container" style="grid-area:handle;"><i class="fas fa-grip-vertical handle text-muted" ${iPD ? '' : 'onclick="cycleHighlight(this)"'}></i></div><div class="exercise-content-wrapper"><div class="exercise-header"><select class="form-control form-control-sm objetivo objetivo-${id}" title="Objetivo" ${iPD ? 'disabled' : ''}><option value="" ${!iD.objetivo ? 'selected' : ''} disabled>-- Objetivo --</option>${OBJETIVOS.map(o => `<option value="${o}" ${o === iD.objetivo ? 'selected' : ''}>${o}</option>`).join('')}</select><select class="form-control form-control-sm grupoMuscular grupoMuscular-${id}" onchange="atualizarExercicios(this)" title="Grupo Muscular" ${iPD ? 'disabled' : ''}><option value="" ${!iD.grupoMuscular ? 'selected' : ''} disabled>-- Grupo Muscular --</option>${eG.map(g => `<option value="${g}" ${g === iD.grupoMuscular ? 'selected' : ''}>${g}</option>`).join('')}</select></div><div class="exercise-main-content"><input type="text" class="form-control form-control-sm exercicio exercicio-${id}" placeholder="Exercício" value="${nE}" ${iPD ? 'readonly' : ''} title="Nome" autocomplete="off" data-exercise-list='${JSON.stringify(cELFG)}'><button type="button" class="btn btn-sm select-exercise-button" onclick="handleExerciseFocus(this)" ${iPD ? 'disabled' : ''} title="Selecionar Exercício"><i class="fas fa-list"></i></button></div><div class="exercise-footer-content"><div class="series-controls"><button type="button" class="btn btn-sm btn-outline-secondary series-btn" onclick="alterarSeries(this,${id},-1)" ${iPD ? 'disabled' : ''} title="Menos Séries"><i class="fas fa-minus"></i></button><input type="number" class="form-control form-control-sm series-value" value="${iD.series || 3}" min="1" max="10" readonly ${iPD ? 'disabled' : ''} title="Séries"><button type="button" class="btn btn-sm btn-outline-secondary series-btn" onclick="alterarSeries(this,${id},1)" ${iPD ? 'disabled' : ''} title="Mais Séries"><i class="fas fa-plus"></i></button></div><div class="series-detail-container"></div></div></div><div style="grid-area:delete;" class="delete-button-container"><button class="btn btn-light btn-sm" onclick="this.closest('.sortable-item').remove()" ${iPD ? 'disabled' : ''} title="Remover"><i class="fas fa-trash text-danger"></i></button></div>`; cE.appendChild(eD); const sI = eD.querySelector('.series-value'); if (sI) { atualizarRepeticoes(sI, id); const sC = eD.querySelectorAll('.series-detail-container .series-column'); iD.seriesData?.forEach((sDI, idx) => { if (idx < sC.length) { const co = sC[idx], rI = co.querySelector('.manual-rep-tempo'), rU = co.querySelector('.rep-tempo-unit'), wI = co.querySelector('.peso-value'), wU = co.querySelector('.peso-unit'); if (rI) rI.value = sDI.repTempo || ''; if (rU) rU.value = sDI.repTempoUnit || 'rep'; if (wI) wI.value = sDI.peso || ''; if (wU) wU.value = sDI.pesoUnit || 'lbs'; } }); } } else if (iD.type === 'observation') { const oD = document.createElement('div'); oD.className = 'observation-container sortable-item border rounded mb-2 bg-light'; oD.dataset.highlightState = iD.highlight || 'neutral'; if (oD.dataset.highlightState !== 'neutral') oD.classList.add(`highlight-${oD.dataset.highlightState}`); if (cE.children.length % 2 === 0) oD.classList.add('exercise-alternate'); if (iPD) oD.classList.add('item-readonly'); oD.innerHTML = `<div class="handle-container" style="grid-area:handle;"><i class="fas fa-grip-vertical handle text-muted" ${iPD ? '' : 'onclick="cycleHighlight(this)"'}></i></div><div class="observation-content-wrapper" style="grid-area:input;"><input type="text" class="form-control form-control-sm observacao-texto observacao-texto-${id}" placeholder="Observação..." value="${iD.observacao || ''}" ${iPD ? 'readonly' : ''} title="Observação"></div><div style="grid-area:delete;" class="delete-button-container"><button class="btn btn-light btn-sm" onclick="this.closest('.sortable-item').remove()" ${iPD ? 'disabled' : ''} title="Remover"><i class="fas fa-trash text-danger"></i></button></div>`; cE.appendChild(oD); } }
function getExercisesData(id) { const lC = document.getElementById(`exercise-list-${id}`); if (!lC) return { exercises: [] }; const items = []; lC.querySelectorAll(':scope > .exercise-container, :scope > .observation-container').forEach(iE => { const hS = iE.dataset.highlightState || 'neutral'; if (iE.classList.contains('exercise-container')) { const oE = iE.querySelector(`.objetivo-${id}`), gME = iE.querySelector(`.grupoMuscular-${id}`), exE = iE.querySelector(`.exercicio-${id}`), sIn = iE.querySelector('.series-value'), obj = oE?.value || '', gM = gME?.value || '', exNFI = exE?.value.trim() || '', ser = sIn ? parseInt(sIn.value, 10) : 0, sD = []; iE.querySelectorAll('.series-detail-container .series-column').forEach(c => { const rI = c.querySelector('.manual-rep-tempo'), rU = c.querySelector('.rep-tempo-unit'), wI = c.querySelector('.peso-value'), wU = c.querySelector('.peso-unit'); sD.push({ repTempo: rI?.value || '', repTempoUnit: rU?.value || 'rep', peso: wI?.value || '', pesoUnit: wU?.value || 'lbs' }); }); if (sD.length > ser) sD.length = ser; while (sD.length < ser) sD.push({ repTempo: '', repTempoUnit: 'rep', peso: '', pesoUnit: 'lbs' }); if (obj || gM || exNFI || sD.some(d => d.repTempo || d.peso)) items.push({ type: 'exercise', objetivo: obj, grupoMuscular: gM, exerciseName: exNFI, exercicio: exNFI, series: ser, seriesData: sD, highlight: hS }); } else if (iE.classList.contains('observation-container')) { const oE = iE.querySelector(`.observacao-texto-${id}`), oV = oE?.value.trim() || ''; if (oV) items.push({ type: 'observation', observacao: oV, highlight: hS }); } }); return { exercises: items }; }
function setReadOnlyState(id, iRO) { const c = document.querySelector(`#card-header-${id}`)?.closest('.card'); if (!c) return; c.classList.toggle('plan-readonly', iRO); c.querySelectorAll('.card-header input:not([readonly]):not(.cliente-nome-display), .card-header select').forEach(e => { if (e.tagName === 'SELECT') e.disabled = iRO; else e.readOnly = iRO; }); const sB = c.querySelector('.salvar-btn'); if (sB) sB.disabled = iRO; const aB = c.querySelector(`.avaliacao-btn`); if (aB) aB.disabled = iRO; const lC = c.querySelector(`#exercise-list-${id}`); if (lC) { if (lC.sortableInstance) { lC.sortableInstance.option('disabled', iRO); lC.style.cursor = iRO ? 'default' : 'auto'; } lC.querySelectorAll('.handle').forEach(h => h.style.cursor = iRO ? 'default' : 'grab'); lC.querySelectorAll('.sortable-item').forEach(i => { i.classList.toggle('item-readonly', iRO); i.querySelectorAll('input:not([type="button"]), select, textarea').forEach(e => { if (e.tagName === 'SELECT') e.disabled = iRO; else e.readOnly = iRO; if (iRO) { e.style.backgroundColor = '#f1f3f4'; e.style.cursor = 'default'; e.style.borderColor = '#e8eaed'; e.style.color = '#5f6368'; if (e.tagName === 'SELECT') e.style.backgroundImage = 'none'; } else { e.style.backgroundColor = ''; e.style.cursor = ''; e.style.borderColor = ''; e.style.color = ''; if (e.tagName === 'SELECT') e.style.backgroundImage = ''; } if (!iRO && e.classList.contains('exercicio')) e.style.cursor = 'text'; }); i.querySelectorAll('button').forEach(b => { if (b.closest('.delete-button-container') || b.classList.contains('series-btn') || b.classList.contains('select-exercise-button')) b.disabled = iRO; }); const hI = i.querySelector('.handle'); if (hI) { if (iRO) { hI.onclick = null; hI.style.cursor = 'default'; } else if (!hI.onclick) { hI.onclick = function () { cycleHighlight(this); }; hI.style.cursor = 'grab'; } } }); } }
function copiarPlano(id) { const p = planos.find(pL => pL.contadorPlano === id); if (!p) { showCustomAlert(`Erro: Plano ${id} não encontrado.`, true); return; } clipboardPlanoData = getExercisesData(id); if (clipboardPlanoData?.exercises?.length > 0) showCustomAlert("Conteúdo copiado!", false); else { showCustomAlert("Nada para copiar.", false); clipboardPlanoData = null; } }
function colarPlano(id) { if (!clipboardPlanoData?.exercises?.length) { showCustomAlert("Nada para colar.", false); return; } const tP = planos.find(pL => pL.contadorPlano === id); if (!tP) { showCustomAlert(`Erro: Plano ${id} não encontrado.`, true); return; } const sS = document.getElementById(`card-header-${id}`)?.querySelector('.status-select'); if (sS?.value === 'Done') { showCustomAlert("Não colar em plano finalizado.", true); return; } const tLC = document.getElementById(`exercise-list-${id}`); if (!tLC) { showCustomAlert(`Container de exercícios ${id} não encontrado.`, true); return; } tLC.innerHTML = ''; clipboardPlanoData.exercises.forEach(i => adicionarExercicioComDados(id, i, tLC, false, MASTER_EXERCISE_DATA)); showCustomAlert("Conteúdo colado! Salve.", false); }
function cycleHighlight(hI) { const i = hI.closest('.sortable-item'); if (!i || i.classList.contains('item-readonly')) return; const cS = i.dataset.highlightState || 'neutral'; let nS; if (cS === 'neutral') nS = 'blue'; else if (cS === 'blue') nS = 'grey'; else nS = 'neutral'; i.dataset.highlightState = nS; i.classList.remove('highlight-blue', 'highlight-grey'); if (nS !== 'neutral') i.classList.add(`highlight-${nS}`); }
function toggleFullscreen() { const dE = document.documentElement; if (isIOS) { const b = document.body; b.classList.contains('ios-fullscreen') ? b.classList.remove('ios-fullscreen') : b.classList.add('ios-fullscreen'); } else !document.fullscreenElement ? dE.requestFullscreen().catch(e => { showCustomAlert("Falha tela cheia: " + (e.message || e), true); }) : document.exitFullscreen && document.exitFullscreen(); setTimeout(() => window.dispatchEvent(new Event('resize')), 150); } // Redimensionar gráficos após fullscreen
function setupKeyboardScrollHandler() { document.body.addEventListener('focusin', e => { const t = e.target; if (!(t.matches('input[type="text"], input[type="email"], input[type="search"], input[type="tel"], input[type="url"], textarea') || t.matches('input[type="number"]') || t.matches('input[type="password"]'))) return; const iMSI = t.matches('#modal-search-input'), mE = t.closest('#exercise-modal'); if (iMSI && mE) { setTimeout(() => { if (document.activeElement === t && mE.style.display !== 'none' && typeof t.scrollIntoView === 'function') t.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' }); }, 300); } else { const iRC = t.readOnly || t.disabled || t.closest('.item-readonly') || t.closest('.plan-readonly'), iFI = t.closest('#filter-container'), iOMI = mE && !iMSI; if (!(iRC || iFI || iOMI)) setTimeout(() => { if (document.activeElement === t && typeof t.scrollIntoView === 'function') t.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' }); }, 300); } }); }

function abrirModalAvaliacao(id) { const p = planos.find(pl => pl.contadorPlano === id); if (!p) { showCustomAlert("Plano não encontrado para avaliação.", true); return; } if(avaliacaoForm) avaliacaoForm.reset(); document.getElementById('avaliacao-planUuid').value = p.planUuid; document.getElementById('avaliacao-contadorPlano').value = id; if (p.avaliacao) { document.getElementById('aval-peso').value = p.avaliacao.peso || ''; document.getElementById('aval-altura').value = p.avaliacao.altura || ''; document.getElementById('aval-massa-muscular').value = p.avaliacao.massaMuscular || ''; document.getElementById('aval-massa-gorda').value = p.avaliacao.massaGorda || ''; document.getElementById('aval-gordura-visceral').value = p.avaliacao.gorduraVisceral || ''; document.getElementById('aval-idade-biologica').value = p.avaliacao.idadeBiologica || ''; document.getElementById('aval-metabolismo-basal').value = p.avaliacao.metabolismoBasal || ''; document.getElementById('aval-massa-ossea').value = p.avaliacao.massaOssea || ''; document.getElementById('aval-h2o').value = p.avaliacao.h2o || ''; document.getElementById('aval-pressao-arterial').value = p.avaliacao.pressaoArterial || ''; document.getElementById('aval-perimetro-abdominal').value = p.avaliacao.perimetroAbdominal || ''; document.getElementById('aval-observacoes').value = p.avaliacao.observacoes || ''; } if (avaliacaoModalOverlay) avaliacaoModalOverlay.style.display = 'block'; if (avaliacaoModal) avaliacaoModal.style.display = 'flex'; setTimeout(() => { if (avaliacaoModal) avaliacaoModal.classList.add('show'); if (avaliacaoModalOverlay) avaliacaoModalOverlay.classList.add('show'); document.getElementById('aval-peso').focus(); }, 50); }
function fecharModalAvaliacao() { if (avaliacaoModal) avaliacaoModal.classList.remove('show'); if (avaliacaoModalOverlay) avaliacaoModalOverlay.classList.remove('show'); setTimeout(() => { if (avaliacaoModal) avaliacaoModal.style.display = 'none'; if (avaliacaoModalOverlay) avaliacaoModalOverlay.style.display = 'none'; }, 250); }
function salvarAvaliacao() { const id = parseInt(document.getElementById('avaliacao-contadorPlano').value), pU = document.getElementById('avaliacao-planUuid').value, p = planos.find(pl => pl.contadorPlano === id && pl.planUuid === pU); if (!p) { showCustomAlert("Erro: Plano não encontrado para salvar avaliação.", true); return; } p.avaliacao = { peso: document.getElementById('aval-peso').value.trim() ? parseFloat(document.getElementById('aval-peso').value) : null, altura: document.getElementById('aval-altura').value.trim() ? parseInt(document.getElementById('aval-altura').value) : null, massaMuscular: document.getElementById('aval-massa-muscular').value.trim() ? parseFloat(document.getElementById('aval-massa-muscular').value) : null, massaGorda: document.getElementById('aval-massa-gorda').value.trim() ? parseFloat(document.getElementById('aval-massa-gorda').value) : null, gorduraVisceral: document.getElementById('aval-gordura-visceral').value.trim() ? parseInt(document.getElementById('aval-gordura-visceral').value) : null, idadeBiologica: document.getElementById('aval-idade-biologica').value.trim() ? parseInt(document.getElementById('aval-idade-biologica').value) : null, metabolismoBasal: document.getElementById('aval-metabolismo-basal').value.trim() ? parseInt(document.getElementById('aval-metabolismo-basal').value) : null, massaOssea: document.getElementById('aval-massa-ossea').value.trim() ? parseFloat(document.getElementById('aval-massa-ossea').value) : null, h2o: document.getElementById('aval-h2o').value.trim() ? parseFloat(document.getElementById('aval-h2o').value) : null, pressaoArterial: document.getElementById('aval-pressao-arterial').value.trim() || null, perimetroAbdominal: document.getElementById('aval-perimetro-abdominal').value.trim() ? parseFloat(document.getElementById('aval-perimetro-abdominal').value) : null, observacoes: document.getElementById('aval-observacoes').value.trim() || null }; salvarPlano(id); fecharModalAvaliacao(); showCustomAlert("Dados de avaliação incluídos. Clique em Salvar no plano para persistir.", false, 4000); }

function abrirModalEstatisticas() { const nF = nomeFiltroInput.value.trim(); if (!nF) { showCustomAlert("Por favor, insira um nome de cliente no filtro para buscar estatísticas.", true); return; } showLoadingIndicator(true); disableActionButtons(); const gS = i => document.getElementById(i)?.value ?? ''; let dI = '', dF = ''; const dP = document.querySelector("#dateRangeFilter")?._flatpickr; if (dP && dP.selectedDates.length > 0) { dI = flatpickr.formatDate(dP.selectedDates[0], "d/m/Y"); if (dP.selectedDates.length > 1) dF = flatpickr.formatDate(dP.selectedDates[1], "d/m/Y"); else dF = dI; } const pT = gS('personalTrainer'), cEF = gS('cor'); google.script.run.withSuccessHandler(mostrarResultadosEstatisticas).withFailureHandler(e => { handleBackendError(e); enableActionButtons(); }).getEstatisticasCliente(nF, dI, dF, pT, cEF); }
function fecharModalEstatisticas() { if (estatisticasModal) estatisticasModal.classList.remove('show'); if (estatisticasModalOverlay) estatisticasModalOverlay.classList.remove('show'); setTimeout(() => { if (estatisticasModal) estatisticasModal.style.display = 'none'; if (estatisticasModalOverlay) estatisticasModalOverlay.style.display = 'none'; }, 250); Object.values(activeCharts).forEach(c => { if(c && typeof c.destroy === 'function') c.destroy(); }); activeCharts = {}; }


// --- Otimização Gráficos: Atualizar em vez de Destruir/Recriar ---
function updateOrCreateChart(chartId, chartType, data, options) {
    const canvasEl = document.getElementById(chartId);
    if (!canvasEl) {
        console.error(`Canvas element ${chartId} not found.`);
        return null;
    }
    const ctx = canvasEl.getContext('2d');
    if (activeCharts[chartId]) {
        activeCharts[chartId].data = data;
        activeCharts[chartId].options = Chart.helpers.merge(activeCharts[chartId].options, options); // Merge para manter algumas opções padrão
        activeCharts[chartId].update();
    } else {
        activeCharts[chartId] = new Chart(ctx, { type: chartType, data: data, options: options });
    }
    return activeCharts[chartId];
}

function updateEvaluationChartsDisplay(hideXAxisCompletely = false) {
    if (!allFetchedEvalSeriesData) {
        if (evalMainChartContainer) evalMainChartContainer.style.display = 'none';
        if (evalAllChartsContainer) evalAllChartsContainer.style.display = 'none';
        const sGC = document.getElementById('estatisticas-graficos-container');
        if (sGC) sGC.style.display = 'none';
        return;
    }
    const sMK = selectEvalMetric.value; // selectedMetricKey
    const metricConfigs = [
        { key: 'peso', label: 'Peso (kg)', color: 'rgb(75,192,192)' },
        { key: 'massaGorda', label: 'Massa Gorda (%)', color: 'rgb(255,99,132)' },
        { key: 'massaMuscular', label: 'Massa Muscular (kg)', color: 'rgb(54,162,235)' },
        { key: 'metabolismoBasal', label: 'Metab. Basal (kcal)', color: 'rgb(255,205,86)' },
        { key: 'h2o', label: 'H2O (%)', color: 'rgb(153,102,255)' },
        { key: 'gorduraVisceral', label: 'Gordura Visceral (nível)', color: 'rgb(255,159,64)' }
    ];

    const commonChartOptionsBase = {
        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
        scales: {
            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'DD MMM', displayFormats: { day: 'DD MMM' } }, ticks: { source: 'data', autoSkip: true, maxRotation: 45, minRotation: 0 }, grid: {}, title: { display: false } },
            y: { ticks: { display: true }, grid: { display: true }, title: { text: '' } }
        },
        plugins: {
            legend: { display: true, position: 'top', labels: { boxWidth: 15, padding: 10 } },
            tooltip: { mode: 'index', intersect: false, bodySpacing: 5, titleSpacing: 6, titleFont: { size: 14 }, bodyFont: { size: 12 }, footerFont: { size: 10 } },
            datalabels: {
                display: true, align: 'top', anchor: 'end', offset: 8, backgroundColor: 'rgba(0,0,0,0.75)', borderRadius: 4, color: 'white', font: { weight: 'normal', size: 9 },
                formatter: (value, context) => {
                    if (typeof value === 'number') {
                        const labelLower = context.dataset.label.toLowerCase();
                        if (labelLower.includes('peso') || labelLower.includes('metab. basal') || labelLower.includes('gordura visceral')) return value.toFixed(0);
                        return value.toFixed(1);
                    } return value;
                }
            }
        }
    };

    const getChartOptions = (yTitle = '', hideX = false) => {
        const opts = JSON.parse(JSON.stringify(commonChartOptionsBase)); // Deep clone
        opts.scales.y.title.text = yTitle;
        opts.scales.y.title.display = !hideX;
        opts.scales.x.ticks.display = !hideX;
        opts.scales.x.grid.display = !hideX;
        return opts;
    };


    if (sMK === "all") {
        if (evalMainChartContainer) evalMainChartContainer.style.display = 'none';
        if (evalAllChartsContainer) evalAllChartsContainer.style.display = 'flex';
        evalAllChartsContainer.innerHTML = ''; // Limpar para recriar divs dos gráficos
        let hasAnySmallChartData = false;

        metricConfigs.forEach(m => {
            const seriesData = allFetchedEvalSeriesData[m.key];
            const chartWrapperDiv = document.createElement('div');
            chartWrapperDiv.className = 'col-lg-4 col-md-6 mb-3';
            const chartContainerDiv = document.createElement('div');
            chartContainerDiv.className = 'chart-container';
            const canvasEl = document.createElement('canvas');
            const chartId = `chart-${m.key}`;
            canvasEl.id = chartId;
            chartContainerDiv.appendChild(canvasEl);
            chartWrapperDiv.appendChild(chartContainerDiv);
            evalAllChartsContainer.appendChild(chartWrapperDiv);

            if (seriesData && seriesData.length > 0) {
                hasAnySmallChartData = true;
                const chartData = {
                    labels: seriesData.map(i => i.date),
                    datasets: [{ label: m.label, data: seriesData.map(i => i.value), borderColor: m.color, backgroundColor: m.color.replace('rgb', 'rgba').replace(')', ',0.3)'), tension: 0.1, fill: true, pointRadius: 3, pointHoverRadius: 5 }]
                };
                const chartOptions = getChartOptions(m.label.split('(')[0].trim(), hideXAxisCompletely);
                updateOrCreateChart(chartId, 'line', chartData, chartOptions);
            } else {
                chartContainerDiv.innerHTML = `<canvas id="${chartId}"></canvas><p class="text-muted small text-center p-2">Sem dados para ${m.label.split('(')[0].trim()}</p>`;
                if(activeCharts[chartId]) { activeCharts[chartId].destroy(); delete activeCharts[chartId];}
            }
        });
        document.getElementById('estatisticas-graficos-container').style.display = hasAnySmallChartData ? 'block' : 'none';
        if (!hasAnySmallChartData) evalAllChartsContainer.innerHTML = '<p class="col-12 text-muted small text-center">Nenhuma data para as métricas de avaliação.</p>';

    } else { // Single chart view
        if (evalMainChartContainer) evalMainChartContainer.style.display = 'block';
        if (evalAllChartsContainer) evalAllChartsContainer.style.display = 'none';

        // Garante que o canvas existe se o container principal for recriado
        if (evalMainChartContainer && !document.getElementById('chart-evaluation-main')) {
            evalMainChartContainer.innerHTML = '<canvas id="chart-evaluation-main"></canvas>';
        }

        const seriesData = allFetchedEvalSeriesData[sMK];
        const metricConfig = metricConfigs.find(m => m.key === sMK) || { label: sMK, color: 'rgb(75,192,192)' }; // Fallback
        const chartId = 'chart-evaluation-main';

        if (seriesData && seriesData.length > 0) {
            const chartData = {
                labels: seriesData.map(i => i.date),
                datasets: [{ label: metricConfig.label, data: seriesData.map(i => i.value), borderColor: metricConfig.color, backgroundColor: metricConfig.color.replace('rgb', 'rgba').replace(')', ',0.3)'), tension: 0.1, fill: true, pointRadius: 3, pointHoverRadius: 5 }]
            };
            const chartOptions = getChartOptions(metricConfig.label.split('(')[0].trim(), hideXAxisCompletely);
            updateOrCreateChart(chartId, 'line', chartData, chartOptions);
            document.getElementById('estatisticas-graficos-container').style.display = 'block';
        } else {
            if (evalMainChartContainer) evalMainChartContainer.innerHTML = `<canvas id="chart-evaluation-main"></canvas><p class="text-muted small text-center p-2">Sem dados para ${metricConfig.label.split('(')[0].trim()}.</p>`;
            if(activeCharts[chartId]) { activeCharts[chartId].destroy(); delete activeCharts[chartId];}
            document.getElementById('estatisticas-graficos-container').style.display = 'none';
        }
    }
}


function updateExerciseLoadChartsByGroup(hideXAxisCompletely = false) {
    const exerciseChartsContainer = document.getElementById('exercise-load-charts-by-group');
    if (!allFetchedExerciseProgressData || !exerciseChartsContainer) {
        if (exerciseChartsContainer) exerciseChartsContainer.innerHTML = '<p class="col-12 text-muted small text-center">Sem dados de progressão de carga.</p>';
        if (exerciseMainProgressChartContainer) exerciseMainProgressChartContainer.style.display = 'none';
        return;
    }
    const selectedMuscleGroup = selectMuscleGroupProgress.value;
    exerciseChartsContainer.innerHTML = ''; // Limpar para recriar divs dos gráficos

    let exercisesInGroup = [];
    if (selectedMuscleGroup === "" || selectedMuscleGroup === "all_groups_top") {
        exercisesInGroup = Object.entries(allFetchedExerciseProgressData)
            .map(([groupName, exercises]) => Object.entries(exercises).map(([exName, exData]) => ({ name: exName, data: exData.progressData, group: groupName })))
            .flat()
            .filter(ex => ex.data && ex.data.length > 0)
            .sort((a, b) => b.data.length - a.data.length) // Exemplo: ordenar por mais pontos de dados
            .slice(0, 4); // Top 4
        if (exercisesInGroup.length === 0) exerciseChartsContainer.innerHTML = '<p class="col-12 text-muted small text-center">Sem dados de progressão de carga para exibir.</p>';
    } else {
        if (allFetchedExerciseProgressData[selectedMuscleGroup]) {
            Object.entries(allFetchedExerciseProgressData[selectedMuscleGroup]).forEach(([exName, exData]) => {
                if (exData.progressData && exData.progressData.length > 0) exercisesInGroup.push({ name: exName, data: exData.progressData });
            });
        }
        if (exercisesInGroup.length === 0) exerciseChartsContainer.innerHTML = `<p class="col-12 text-muted small text-center">Sem dados de progressão de carga para o grupo ${selectedMuscleGroup}.</p>`;
    }

    if (exercisesInGroup.length > 0) {
        if (exerciseMainProgressChartContainer) exerciseMainProgressChartContainer.style.display = 'block';
    } else {
        if (exerciseMainProgressChartContainer) exerciseMainProgressChartContainer.style.display = 'none';
        return;
    }

    const chartColors = ['rgba(255,99,132,0.9)', 'rgba(54,162,235,0.9)', 'rgba(255,206,86,0.9)', 'rgba(75,192,192,0.9)', 'rgba(153,102,255,0.9)'];
    let colorIndex = 0;

    const commonLineOptionsBase = {
        responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
        scales: {
            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'DD MMM', displayFormats: { day: 'DD MMM' } }, ticks: { source: 'data', autoSkip: true, maxRotation: 45, minRotation: 0 }, grid: {}, title: { display: false } },
            y: { beginAtZero: false, ticks: { display: true }, grid: { display: true }, title: { text: 'Peso Carga' } }
        },
        plugins: {
            legend: { display: true, position: 'top', labels: { padding: 10, boxWidth: 12 } },
            tooltip: { mode: 'index', intersect: false, bodySpacing: 5, titleSpacing: 6, titleFont: { size: 13 }, bodyFont: { size: 11 } },
            datalabels: { display: true, align: 'top', anchor: 'end', offset: 8, backgroundColor: 'rgba(0,0,0,0.75)', borderRadius: 4, color: 'white', font: { weight: 'normal', size: 9 }, formatter: (value) => typeof value === 'number' ? value.toFixed(1) : value }
        },
        font: { size: 11 }
    };

    const getLineChartOptions = (yTitle = 'Peso Carga', hideX = false) => {
        const opts = JSON.parse(JSON.stringify(commonLineOptionsBase));
        opts.scales.y.title.text = yTitle;
        opts.scales.y.title.display = !hideX;
        opts.scales.x.ticks.display = !hideX;
        opts.scales.x.grid.display = !hideX;
        return opts;
    };

    exercisesInGroup.forEach(ex => {
        const progressData = ex.data;
        if (progressData && progressData.length > 0) {
            const chartId = `chart-ex-load-${ex.name.replace(/[^a-zA-Z0-9]/g, '')}`;
            const chartWrapperDiv = document.createElement('div'); chartWrapperDiv.className = 'col-md-6 mb-3';
            const chartContainerDiv = document.createElement('div'); chartContainerDiv.className = 'chart-container';
            const canvasEl = document.createElement('canvas'); canvasEl.id = chartId;
            chartContainerDiv.appendChild(canvasEl); chartWrapperDiv.appendChild(chartContainerDiv);
            exerciseChartsContainer.appendChild(chartWrapperDiv);

            const currentColor = chartColors[colorIndex % chartColors.length];
            const chartData = {
                labels: progressData.map(i => i.date),
                datasets: [{ label: `${ex.name} (${progressData[0]?.unit || 'kg'})`, data: progressData.map(i => i.weight), borderColor: currentColor, backgroundColor: currentColor.replace('0.9)', '0.3)'), tension: 0.1, fill: true, pointRadius: 2, pointHoverRadius: 4 }]
            };
            const chartOptions = getLineChartOptions(`Peso Carga (${progressData[0]?.unit || 'kg'})`, hideXAxisCompletely);
            updateOrCreateChart(chartId, 'line', chartData, chartOptions);
            colorIndex++;
        }
    });
}


function mostrarResultadosEstatisticas(data) {
    showLoadingIndicator(false); enableActionButtons();
    const eOC = document.getElementById('export-options-container'); // exportOptionsContainer
    if (!data || data.erro) {
        showCustomAlert(data?.mensagem || data?.erro || "Erro ao carregar estatísticas.", true);
        if (estatisticasModal) estatisticasModal.style.display = 'none';
        if (estatisticasModalOverlay) estatisticasModalOverlay.style.display = 'none';
        if (eOC) eOC.style.display = 'none';
        return;
    }
    document.getElementById('estatisticas-titulo').textContent = `Estatísticas: ${data.clienteNome}`;
    document.getElementById('estatisticas-cliente-periodo').textContent = `Período: ${data.periodo.inicio} - ${data.periodo.fim}`;
    const pDD = document.getElementById('estatisticas-planos-detalhes'), wACD = document.getElementById('estatisticas-workout-analysis-container'), sDD = document.getElementById('estatisticas-sem-dados'), eLCBGD = document.getElementById('exercise-load-charts-by-group');
    pDD.innerHTML = '<h6><i class="fas fa-clipboard-list"></i> Detalhes dos Treinos no Período</h6>';
    if (eLCBGD) eLCBGD.innerHTML = ''; // Limpar gráficos de carga anteriores
    let hAD = false; // hasAnyData
    if (data.planosDetalhes && data.planosDetalhes.length > 0) {
        hAD = true; pDD.style.display = 'block';
        data.planosDetalhes.forEach(pl => {
            const pE = document.createElement('div'); pE.className = 'mb-3 p-2 border rounded bg-light';
            let pH = `<p class="mb-1"><strong>Data: ${pl.data}</strong></p>`;
            if (pl.avaliacao && Object.keys(pl.avaliacao).some(k => pl.avaliacao[k] !== null && pl.avaliacao[k] !== '' && k !== 'error')) {
                pH += '<div class="mb-1"><strong>Avaliação Física:</strong><ul class="list-unstyled small mb-0 pl-3">';
                for (const k in pl.avaliacao) { if (pl.avaliacao[k] !== null && pl.avaliacao[k] !== '' && k !== 'error') pH += `<li><span class="text-muted">${formatAvaliacaoKey(k)}:</span> ${pl.avaliacao[k]}</li>`; }
                pH += '</ul></div>';
            }
            if (pl.exercicios && pl.exercicios.length > 0) {
                pH += '<div class="mt-1"><strong>Exercícios:</strong><ul class="list-unstyled small mb-0 pl-3">';
                pl.exercicios.forEach(ex => {
                    pH += `<li>`;
                    if (ex.type === 'exercise') {
                        pH += `<strong>${ex.exerciseName || ex.exercicio || 'Exercício'}</strong> <small class="text-muted">(${ex.grupoMuscular || 'N/A'} | ${ex.objetivo || 'N/A'})</small>`;
                        if (ex.seriesData && ex.seriesData.length > 0) {
                            pH += ` <span class="text-info">- ${ex.series}x: `;
                            ex.seriesData.forEach(sd => { pH += `[${sd.repTempo || '-'}${sd.repTempoUnit || ''} @ ${sd.peso || '-'}${sd.pesoUnit || ''}] `; });
                            pH += '</span>';
                        }
                    } else if (ex.type === 'observation' && ex.observacao) pH += `<span class="text-muted"><em>Obs: ${ex.observacao}</em></span>`;
                    pH += '</li>';
                });
                pH += '</ul></div>';
            }
            pE.innerHTML = pH; pDD.appendChild(pE);
        });
    } else pDD.style.display = 'none';

    // Limpar gráficos antigos antes de popular com novos dados
    Object.keys(activeCharts).forEach(key => { if (activeCharts[key] && typeof activeCharts[key].destroy === 'function') { activeCharts[key].destroy(); delete activeCharts[key]; }});

    allFetchedEvalSeriesData = data.avaliacoesSeries || {};
    allFetchedExerciseProgressData = data.workoutAnalysis?.exerciseWeightProgress || {};
    const hIAS = document.getElementById('toggleXAxisLabels')?.checked ?? true; // hideIndividualAxisAndScale

    if (selectEvalMetric) {
        selectEvalMetric.removeEventListener('change', toggleChartXAxisLabels); // Prevenir múltiplos listeners
        selectEvalMetric.addEventListener('change', toggleChartXAxisLabels);
        if (Object.keys(allFetchedEvalSeriesData).length > 0 && Object.values(allFetchedEvalSeriesData).some(arr => arr && arr.length > 0)) {
            updateEvaluationChartsDisplay(hIAS); hAD = true;
            document.getElementById('estatisticas-graficos-container').style.display = 'block';
        } else {
            document.getElementById('estatisticas-graficos-container').style.display = 'none';
            if (evalMainChartContainer) evalMainChartContainer.style.display = 'none';
            if (evalAllChartsContainer) evalAllChartsContainer.style.display = 'none';
        }
    } else document.getElementById('estatisticas-graficos-container').style.display = 'none';

    const sMGP = document.getElementById('select-muscle-group-progress'); // selectMuscleGroupProgress
    if (sMGP) {
        sMGP.innerHTML = '<option value="all_groups_top">-- Top Exercícios (Todos Grupos) --</option>'; // Reset options
        if (data.workoutAnalysis?.exerciseWeightProgress) {
            const mGs = Object.keys(data.workoutAnalysis.exerciseWeightProgress); // muscleGroups
            mGs.sort().forEach(gN => { if (data.workoutAnalysis.exerciseWeightProgress[gN] && Object.values(data.workoutAnalysis.exerciseWeightProgress[gN]).some(ex => ex.progressData && ex.progressData.length > 0)) { const o = document.createElement('option'); o.value = gN; o.textContent = gN; sMGP.appendChild(o); } });
        }
        sMGP.removeEventListener('change', toggleChartXAxisLabels); // Prevenir múltiplos listeners
        sMGP.addEventListener('change', toggleChartXAxisLabels);
        if (Object.keys(allFetchedExerciseProgressData).length > 0 && Object.values(allFetchedExerciseProgressData).some(g => Object.values(g).some(ex => ex.progressData && ex.progressData.length > 0))) {
            updateExerciseLoadChartsByGroup(hIAS); hAD = true;
            if (exerciseMainProgressChartContainer) exerciseMainProgressChartContainer.style.display = 'block';
        } else { if (exerciseMainProgressChartContainer) exerciseMainProgressChartContainer.style.display = 'none'; }
    } else { if (exerciseMainProgressChartContainer) exerciseMainProgressChartContainer.style.display = 'none'; }

    let hWPD = false; // hasWorkoutPieData
    const cCP = ['rgba(255,99,132,0.85)', 'rgba(54,162,235,0.85)', 'rgba(255,206,86,0.85)', 'rgba(75,192,192,0.85)', 'rgba(153,102,255,0.85)', 'rgba(255,159,64,0.85)', 'rgba(201,203,207,0.85)', 'rgba(50,50,50,0.85)']; // chartColorsPie
    if (data.workoutAnalysis) {
        const mGC = document.getElementById('chart-muscle-group'); // muscleGroupCanvas
        if (data.workoutAnalysis.muscleGroupUsage && Object.keys(data.workoutAnalysis.muscleGroupUsage).length > 0 && mGC) {
            hWPD = true; const mGL = Object.keys(data.workoutAnalysis.muscleGroupUsage), mGD = Object.values(data.workoutAnalysis.muscleGroupUsage);
            const muscleGroupChartData = { labels: mGL, datasets: [{ label: 'Grupos Musculares', data: mGD, backgroundColor: cCP.slice(0, mGL.length) }] };
            const muscleGroupChartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, datalabels: { color: '#fff', font: {weight: 'bold'}, formatter: (v,ctx) => {let sum=0; let dataArr=ctx.chart.data.datasets[0].data; dataArr.map(d=>{sum+=d;}); let pct=(v*100/sum).toFixed(1)+"%"; return pct;}} }};
            updateOrCreateChart('chart-muscle-group', 'doughnut', muscleGroupChartData, muscleGroupChartOptions);
        } else if (mGC) { if(activeCharts['chart-muscle-group']) activeCharts['chart-muscle-group'].destroy(); delete activeCharts['chart-muscle-group']; mGC.getContext('2d').clearRect(0, 0, mGC.width, mGC.height); }

        const oC = document.getElementById('chart-objective'); // objectiveCanvas
        if (data.workoutAnalysis.objectiveUsage && Object.keys(data.workoutAnalysis.objectiveUsage).length > 0 && oC) {
            hWPD = true; const oL = Object.keys(data.workoutAnalysis.objectiveUsage), oD = Object.values(data.workoutAnalysis.objectiveUsage);
            const objectiveChartData = { labels: oL, datasets: [{ label: 'Objetivos', data: oD, backgroundColor: cCP.slice(0, oL.length).reverse() }] };
            const objectiveChartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, datalabels: { color: '#fff', font: {weight: 'bold'}, formatter: (v,ctx) => {let sum=0; let dataArr=ctx.chart.data.datasets[0].data; dataArr.map(d=>{sum+=d;}); let pct=(v*100/sum).toFixed(1)+"%"; return pct;}} }};
            updateOrCreateChart('chart-objective', 'doughnut', objectiveChartData, objectiveChartOptions);
        } else if (oC) { if(activeCharts['chart-objective']) activeCharts['chart-objective'].destroy(); delete activeCharts['chart-objective']; oC.getContext('2d').clearRect(0, 0, oC.width, oC.height); }
    }
    if (wACD) wACD.style.display = hWPD || (sMGP && Object.keys(allFetchedExerciseProgressData).length > 0 && Object.values(allFetchedExerciseProgressData).some(g => Object.keys(g).length > 0)) ? 'block' : 'none';
    if (hWPD || (sMGP && Object.keys(allFetchedExerciseProgressData).length > 0 && Object.values(allFetchedExerciseProgressData).some(g => Object.keys(g).length > 0))) hAD = true;
    sDD.style.display = !hAD ? 'block' : 'none';
    if (eOC) eOC.style.display = hAD ? 'block' : 'none';
    if (estatisticasModalOverlay) estatisticasModalOverlay.style.display = 'block';
    if (estatisticasModal) estatisticasModal.style.display = 'flex';
    setTimeout(() => { if (estatisticasModal) estatisticasModal.classList.add('show'); if (estatisticasModalOverlay) estatisticasModalOverlay.classList.add('show'); }, 50);
}


function toggleChartXAxisLabels() {
    const hide = document.getElementById('toggleXAxisLabels')?.checked ?? true;
    // As funções de atualização dos gráficos agora recebem este parâmetro
    updateEvaluationChartsDisplay(hide);
    updateExerciseLoadChartsByGroup(hide);
}
function formatAvaliacaoKey(key) { const map = { peso: "Peso", altura: "Altura", massaMuscular: "M. Muscular", massaGorda: "M. Gorda", gorduraVisceral: "G. Visceral", idadeBiologica: "Idade Biológica", metabolismoBasal: "Metab. Basal", massaOssea: "M. Óssea", h2o: "H2O (%)", pressaoArterial: "P. Arterial", perimetroAbdominal: "Per. Abdominal", observacoes: "Obs. Avaliação" }; return map[key] || key.charAt(0).toUpperCase() + key.slice(1); }
function aplicarOpcoesImpressao(targetElementId = 'estatisticas-body-content', forPdfCapture = false) { const contentToProcess = document.getElementById(targetElementId); if (!contentToProcess) return; const sections = { evalMetrics: document.getElementById('estatisticas-graficos-container'), workoutAnalysis: document.getElementById('estatisticas-workout-analysis-container'), planDetails: document.getElementById('estatisticas-planos-detalhes') }; Object.keys(sections).forEach(key => { const checkbox = document.getElementById(`printOpt${key.charAt(0).toUpperCase() + key.slice(1)}`); const sectionEl = sections[key]; if (sectionEl) { const shouldBeVisible = checkbox ? checkbox.checked : true; if (forPdfCapture) { sectionEl.style.display = shouldBeVisible ? '' : 'none'; } else { if (shouldBeVisible) { sectionEl.classList.remove('d-print-none-true'); } else { sectionEl.classList.add('d-print-none-true'); } } } }); if (forPdfCapture) { if (!contentToProcess.dataset.originalHeight) { contentToProcess.dataset.originalHeight = contentToProcess.style.height; contentToProcess.dataset.originalOverflowY = contentToProcess.style.overflowY; contentToProcess.dataset.originalMaxHeight = contentToProcess.style.maxHeight; } contentToProcess.style.height = 'auto'; contentToProcess.style.overflowY = 'visible'; contentToProcess.style.maxHeight = 'none'; const modalContent = estatisticasModal.querySelector('.modal-content'); if (modalContent && !modalContent.dataset.originalMaxHeight) { modalContent.dataset.originalMaxHeight = modalContent.style.maxHeight; modalContent.style.maxHeight = 'none'; } } }
function reverterOpcoesImpressao(targetElementId = 'estatisticas-body-content') { const contentToProcess = document.getElementById(targetElementId); if (!contentToProcess) return; document.querySelectorAll('.d-print-none-true').forEach(el => el.classList.remove('d-print-none-true')); document.querySelectorAll('#estatisticas-body-content [style*="display: none"]').forEach(el => { const sectionId = el.id; let optKey = ''; if (sectionId === 'estatisticas-graficos-container') optKey = 'EvalMetrics'; else if (sectionId === 'estatisticas-workout-analysis-container') optKey = 'WorkoutAnalysis'; else if (sectionId === 'estatisticas-planos-detalhes') optKey = 'PlanDetails'; const checkbox = optKey ? document.getElementById(`printOpt${optKey}`) : null; if (checkbox && checkbox.checked) { el.style.display = ''; } else if (!checkbox) { el.style.display = ''; } }); if (contentToProcess.dataset.originalHeight !== undefined) { contentToProcess.style.height = contentToProcess.dataset.originalHeight; contentToProcess.style.overflowY = contentToProcess.dataset.originalOverflowY; contentToProcess.style.maxHeight = contentToProcess.dataset.originalMaxHeight; delete contentToProcess.dataset.originalHeight; delete contentToProcess.dataset.originalOverflowY; delete contentToProcess.dataset.originalMaxHeight; } const modalContent = estatisticasModal.querySelector('.modal-content'); if (modalContent && modalContent.dataset.originalMaxHeight !== undefined) { modalContent.style.maxHeight = modalContent.dataset.originalMaxHeight; delete modalContent.dataset.originalMaxHeight; } }
function imprimirEstatisticas() { aplicarOpcoesImpressao('estatisticas-body-content', false); estatisticasModal.classList.add('print-mode'); setTimeout(() => { window.print(); }, 250); }
window.onafterprint = () => { estatisticasModal.classList.remove('print-mode'); reverterOpcoesImpressao('estatisticas-body-content'); };
async function baixarPdfEstatisticas() { showLoadingIndicator(true); const { jsPDF } = window.jspdf; const contentToCapture = document.getElementById('estatisticas-body-content'); const modalTitle = document.getElementById('estatisticas-titulo').textContent; const modalPeriod = document.getElementById('estatisticas-cliente-periodo').textContent; aplicarOpcoesImpressao('estatisticas-body-content', true); const originalStyles = new Map(); const elementsToHideForCapture = [estatisticasModal.querySelector('.modal-header'), estatisticasModal.querySelector('.modal-footer'), document.getElementById('export-options-container')]; elementsToHideForCapture.forEach(el => { if (el) { originalStyles.set(el, { display: el.style.display, visibility: el.style.visibility }); el.style.display = 'none'; } }); Chart.defaults.animation = false; Object.values(activeCharts).forEach(chart => { if (chart.canvas.offsetParent !== null) { chart.update('none'); } }); await new Promise(resolve => setTimeout(resolve, 600)); try { const canvas = await html2canvas(contentToCapture, { scale: 1.5, useCORS: true, logging: false, onclone: (clonedDoc) => { const clonedContent = clonedDoc.getElementById('estatisticas-body-content'); if (clonedContent) { clonedContent.style.height = 'auto'; clonedContent.style.overflowY = 'visible'; clonedContent.style.maxHeight = 'none'; const clonedSections = { evalMetrics: clonedDoc.getElementById('estatisticas-graficos-container'), workoutAnalysis: clonedDoc.getElementById('estatisticas-workout-analysis-container'), planDetails: clonedDoc.getElementById('estatisticas-planos-detalhes') }; Object.keys(clonedSections).forEach(key => { const checkbox = document.getElementById(`printOpt${key.charAt(0).toUpperCase() + key.slice(1)}`); const sectionEl = clonedSections[key]; if (sectionEl && checkbox && !checkbox.checked) { sectionEl.style.display = 'none'; } }); } } }); const imgData = canvas.toDataURL('image/png'); const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' }); const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight(); const margin = 10; const contentWidth = pdfWidth - 2 * margin; const imgOriginalWidth = canvas.width; const imgOriginalHeight = canvas.height; let yPos = margin; pdf.setFontSize(14); pdf.text(modalTitle, pdfWidth / 2, yPos, { align: 'center' }); yPos += 7; pdf.setFontSize(10); pdf.text(modalPeriod, pdfWidth / 2, yPos, { align: 'center' }); yPos += 10; let remainingCanvasHeight = imgOriginalHeight; let currentCanvasY = 0; const availablePageHeightInitial = pdfHeight - margin - yPos; while (remainingCanvasHeight > 0) { const currentPageAvailableHeight = (currentCanvasY === 0) ? availablePageHeightInitial : (pdfHeight - 2 * margin); const pdfImageSliceHeight = Math.min(currentPageAvailableHeight, remainingCanvasHeight * (contentWidth / imgOriginalWidth)); const canvasSliceHeight = pdfImageSliceHeight * (imgOriginalWidth / contentWidth); if (currentCanvasY > 0) { pdf.addPage(); yPos = margin; } const sliceCanvas = document.createElement('canvas'); sliceCanvas.width = imgOriginalWidth; sliceCanvas.height = Math.min(canvasSliceHeight, remainingCanvasHeight); const sliceCtx = sliceCanvas.getContext('2d'); sliceCtx.drawImage(canvas, 0, currentCanvasY, imgOriginalWidth, sliceCanvas.height, 0, 0, imgOriginalWidth, sliceCanvas.height); pdf.addImage(sliceCanvas.toDataURL('image/png'), 'PNG', margin, yPos, contentWidth, pdfImageSliceHeight); remainingCanvasHeight -= canvasSliceHeight; currentCanvasY += canvasSliceHeight; yPos += pdfImageSliceHeight + 5; } pdf.save(`${modalTitle.replace(/[^a-zA-Z0-9]/g, '_')}_Stats.pdf`); } catch (err) { console.error("Error generating PDF:", err); showCustomAlert("Erro ao gerar PDF. Tente 'Imprimir' e salvar como PDF.", true); } finally { Chart.defaults.animation = {}; elementsToHideForCapture.forEach(el => { if (el) { const original = originalStyles.get(el); el.style.display = original.display; } }); reverterOpcoesImpressao('estatisticas-body-content'); showLoadingIndicator(false); } }

function displayClienteSuggestions(suggestions, inputText) {
    if (!clienteSuggestionsDropdown) return;
    clienteSuggestionsDropdown.innerHTML = '';
    if (suggestions && suggestions.length > 0) {
        suggestions.forEach(suggestion => {
            const item = document.createElement('a');
            item.classList.add('dropdown-item');
            item.href = '#'; // Prevenir navegação
            // Destacar o texto de entrada na sugestão
            const regex = new RegExp(`(${inputText.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&")})`, 'gi');
            item.innerHTML = suggestion.replace(regex, '<strong>$1</strong>');
            item.addEventListener('click', (e) => {
                e.preventDefault();
                if (nomeFiltroInput) nomeFiltroInput.value = suggestion;
                hideClienteSuggestions();
            });
            clienteSuggestionsDropdown.appendChild(item);
        });
        clienteSuggestionsDropdown.style.display = 'block';
    } else {
        hideClienteSuggestions();
    }
}
function hideClienteSuggestions() {
    if (clienteSuggestionsDropdown) clienteSuggestionsDropdown.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
    setupAlerts();
    flatpickr("#dateRangeFilter", { mode: "range", dateFormat: "d/m/Y", locale: "pt" });
    const appIcon = document.getElementById('appIcon');
    const toggleFilterBtn = document.getElementById('toggleFilter');
    const filterPlansBtn = document.querySelector('#filter-button-container button.btn-primary');
    const calcularMetricasBtn = document.getElementById('calcularMetricasBtn');
    const estatisticasBtn = document.getElementById('estatisticasBtn');

    if (appIcon) appIcon.addEventListener('click', toggleFullscreen);
    if (toggleFilterBtn) toggleFilterBtn.addEventListener('click', toggleFilterVisibility);
    if (filterPlansBtn) filterPlansBtn.addEventListener('click', filtrarPlanos);
    if (calcularMetricasBtn) calcularMetricasBtn.addEventListener('click', executarCalculoMetricas);
    if (estatisticasBtn) estatisticasBtn.addEventListener('click', abrirModalEstatisticas);

    // Lógica de sugestões para nome do cliente
    if (nomeFiltroInput && clienteSuggestionsDropdown) {
        nomeFiltroInput.addEventListener('input', () => {
            clearTimeout(clienteSuggestionTimeout);
            const inputText = nomeFiltroInput.value.trim();
            if (inputText.length < 2) { hideClienteSuggestions(); return; } // Mínimo 2 caracteres para buscar
            clienteSuggestionTimeout = setTimeout(() => {
                const cor = document.getElementById('cor')?.value ?? '';
                const personalTrainer = document.getElementById('personalTrainer')?.value ?? '';
                google.script.run
                    .withSuccessHandler(suggestions => { displayClienteSuggestions(suggestions, inputText); })
                    .withFailureHandler(err => { console.error("Erro sugestões cliente:", err); hideClienteSuggestions(); })
                    .getClientSuggestions(inputText, cor, personalTrainer);
            }, 500); // Debounce para evitar chamadas excessivas
        });
        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(event) {
            if (nomeFiltroInput && !nomeFiltroInput.contains(event.target) && clienteSuggestionsDropdown && !clienteSuggestionsDropdown.contains(event.target)) {
                hideClienteSuggestions();
            }
        });
    }

    // Fechar modais ao clicar no overlay
    const overlaysToCloseModals = {
        'avaliacao-modal-overlay': fecharModalAvaliacao,
        'estatisticas-modal-overlay': fecharModalEstatisticas,
        'exercise-modal-overlay': hideExerciseModal // Assumindo que o overlay do modal de exercício também tem ID
    };
    for (const overlayId in overlaysToCloseModals) {
        const overlay = document.getElementById(overlayId);
        if (overlay) {
            overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlaysToCloseModals[overlayId](); } });
        }
    }
    // Lidar com o overlay principal de alertas, especialmente para o modal de exercício
    const mainAlertOverlay = document.getElementById('custom-alert-overlay');
    if (mainAlertOverlay) {
        mainAlertOverlay.addEventListener('click', e => {
            const eMR = document.getElementById('exercise-modal'); // exerciseModalReference
            if (e.target === mainAlertOverlay && eMR && eMR.style.display !== 'none') {
                hideExerciseModal(); // Se o modal de exercício estiver aberto e o clique for no overlay dele
            } else if (e.target === mainAlertOverlay) {
                hideCustomAlert(); // Caso contrário, é o alerta normal
            }
        });
    }

    // Fechar modais com a tecla Escape
    document.addEventListener('keydown', e => {
        const eMR = document.getElementById('exercise-modal');
        if (e.key === 'Escape') {
            if (eMR && eMR.style.display !== 'none') {
                // Não fechar se o foco estiver no input de busca e houver texto
                if (document.activeElement === modalSearchInput && modalSearchInput.value !== '') return;
                e.preventDefault(); hideExerciseModal();
            } else if (avaliacaoModal && avaliacaoModal.style.display !== 'none') {
                e.preventDefault(); fecharModalAvaliacao();
            } else if (estatisticasModal && estatisticasModal.style.display !== 'none') {
                e.preventDefault(); fecharModalEstatisticas();
            } else if (alertDiv && alertDiv.style.display !== 'none') {
                e.preventDefault(); hideCustomAlert();
            }
        }
        // Enter no modal de seleção de exercício
        if (e.key === 'Enter' && eMR && eMR.style.display !== 'none' && document.activeElement === modalSearchInput) {
            e.preventDefault(); const sT = modalSearchInput.value.trim(); if (!sT) return;
            const mI = modalListContainer.querySelectorAll('.suggestion-item, .add-new-suggestion'); // modalItems
            if (mI.length > 0) {
                if (mI.length === 1 && mI[0].classList.contains('add-new-suggestion')) { // Se só houver "adicionar novo"
                    mI[0].click();
                } else { // Selecionar o primeiro item da lista ou "adicionar novo" se for o único
                    const fS = modalListContainer.querySelector('.suggestion-item'); // firstSuggestion
                    if (fS) selectExerciseFromModal(fS.textContent);
                    else { const aS = modalListContainer.querySelector('.add-new-suggestion'); if (aS) aS.click(); }
                }
            }
        }
    });
    const mCB = document.querySelector('.exercise-select-modal .modal-close-btn'); // modalCloseButton
    if (mCB) mCB.addEventListener('click', hideExerciseModal);
    setupKeyboardScrollHandler();
});
</script>
